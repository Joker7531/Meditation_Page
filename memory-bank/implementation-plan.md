下面是一份面向 AI 开发者的 **MVP 基础版本**实施计划（无代码），把需求拆成**小而具体**的步骤；每一步都带一个可执行的**验证测试**（单元/组件/端到端/人工验收其一或组合）。内容以你给的 GDD + Tech Stack 为准，重点交付「能跑通的 4-7-8 呼吸引导」而不是做满所有增强项。

---

## 0) 交付边界与原则（先对齐，避免返工）

### Step 0.1 — 锁定 MVP 范围与“非做不可/明确不做”
- 明确本次只做：
  - 3 页面：Landing / Meditation / Completion
  - 4-7-8（19 秒一轮）循环
  - 时长选择（5/10/15 + 自定义 1–60 整数）与校验
  - 控制：暂停/继续、重新开始、结束
  - 完成页：实际时长；正常完成显示轮数；提前结束标记
- 明确本次不做（按文档 8.3）：登录、历史、音频、移动端、PWA 等。

### Step 0.2 — 关键口径与决策（写死，便于实现与测试）
- 时长传递：URL Query 为主，`sessionStorage` 为补强
  - Landing → Meditation：通过 query 传 `durationMin`
  - `sessionStorage`：用于 refresh / shallow navigation 等情况下恢复
  - 直达 `/meditation` 缺参数：默认 10 分钟，并显示提示（同时写入 `sessionStorage`）
- 自定义时长：1–60 分钟，仅整数，步进 1 分钟
- 目标时长换算：`targetDurationSec = durationMin * 60`
- 4-7-8 阶段：`t < 4` inhale；`4 <= t < 11` hold；`11 <= t < 19` exhale；边界时显示下一阶段文案
- 暂停语义：暂停时冻结计时与动画相位；继续时从当前位置推进
- 提早结束显示：`completedCycles = floor(elapsedActiveSec / 19)`（做完 1 轮显示 1，下一轮不完整不计入）
- 时间推进/阶段提示：由 `requestAnimationFrame` 作为真源驱动
- 缩放动画：严格按 4/7/8 分段；段内 `ease-in-out` 插值；4s/11s/19s 边界严格对齐
- `prefers-reduced-motion: reduce`：计时与引导文案逻辑不变；禁用粒子；缩放改为阶段离散状态（阶段内 `transform` 恒定，仅允许阶段切换短过渡）或完全静态
- 测试精度：unit（逻辑层）可 fake timers，±50ms/±100ms；UI 按整秒；E2E 禁止依赖 ms 精度，使用区间容差
- `<500KB` 口径：生产模式首次加载时 Network 中 `/_next/static/` 的 JS(+CSS) `Transferred` 总和；优先 br（无 br 则 gzip），并注明
- 人工走查：对照 GDD 第 8/10 节勾选项，输出一份“本次包含/不包含”清单，团队确认无歧义。

---

## 1) 项目骨架与质量门禁

### Step 1.1 — 初始化 Next.js App Router 基础结构
- 建立路由结构：
  - `/` Landing
  - `/meditation` Meditation
  - `/completion` Completion
- 定义基础布局：深色背景、居中容器、可访问性焦点样式（Tab 可见）。

**测试**
- Playwright E2E：访问 `/`、`/meditation`、`/completion` 三个路径均返回 200 且页面可见主标题/主容器（最简占位即可）。

### Step 1.2 — 引入 Tailwind + 基础设计 Tokens（仅 MVP 需要）
- 设定全局背景色、正文色、按钮默认样式、焦点 ring 样式。
- 约束：所有可交互元素用语义标签（`button`、`input`、`label`）。

**测试**
- React Testing Library：渲染 Landing，断言存在 `role="button"` 的开始按钮、存在 `label` 关联的自定义输入框（可用 `getByLabelText`）。

### Step 1.3 — 测试框架与最小 CI 规则（本地即可）
- 配置并跑通：Vitest、RTL、Playwright 三类测试入口。
- 设定最小质量门槛：
  - `lint` 通过
  - `test` 通过
  - `e2e` 至少跑通“Landing 打开”用例

**测试**
- 执行层面：在本地运行一次完整命令链（lint + unit + e2e）全部通过；记录在 README 的“验证步骤”。

---

## 2) 领域模型与状态口径（先定标准，再做 UI）

### Step 2.1 — 定义 Session 状态机（文字版即可）
- 明确状态与转换（建议写成文档/注释，不写代码也要明确）：
  - `idle`（未开始）→ `running`（开始）
  - `running` ↔ `paused`
  - `running/paused` → `completed`（自动结束）
  - `running/paused` → `aborted`（手动结束）
  - `running/paused` → `running`（重开：清零并从吸气开始）
- 明确核心字段口径（按 GDD 5.2.5 / 7 节）：
  - `targetDurationSec`
  - `elapsedActiveSec`（不含暂停）
  - `completedCycles = floor(elapsedActiveSec / 19)`
  - `endReason: "normal" | "early"`

**测试**
- Vitest（纯逻辑测试）：给定一组“暂停-继续-结束”的时间片输入，断言 `elapsedActiveSec` 不包含暂停段，`completedCycles` 计算正确。

### Step 2.2 — 定义 4-7-8 阶段计算规则（单一真源）
- 定义一条规则：用“当前轮内偏移秒”决定阶段与文案：
  - 0–4：Inhale（Breathe in）
  - 4–11：Hold
  - 11–19：Exhale（Breathe out）
- 明确边界点（例如 4.000s 时文案切换到 Hold）。

**测试**
- Vitest：对 `t = 0, 3.99, 4.0, 10.99, 11.0, 18.99` 这些边界点进行断言，输出阶段与文案必须符合表格。

---

## 3) Landing 页（时长选择 + 校验 + 导航）

### Step 3.1 — 预设时长选择（互斥）
- UI：3 个按钮（5/10/15 分钟）。
- 交互：
  - 点预设：高亮选中；清空自定义输入；开始按钮可用。
  - 再点其他预设：互斥切换。

**测试**
- RTL：点击“10 分钟”后断言其处于选中状态；再点“5 分钟”断言“10 分钟”取消选中且“5 分钟”选中。

### Step 3.2 — 自定义输入（1–60，整数）与 Zod 校验
- 输入规则：
  - 输入自定义时长：取消任何预设高亮。
  - 非法/超范围提示：`“请输入 1-60 之间的整数”`
  - 非法时开始按钮禁用。
- 仅在需要时显示错误（建议：blur 或点击开始时触发；但必须满足“校验失败可见且不可开始”）。

**测试**
- RTL：输入 `0` 或 `61` 或 `1.5` 或 `abc`，断言错误文案出现且开始按钮 `disabled`。

### Step 3.3 — 开始按钮：带上时长参数进入 Meditation
- 进入 `/meditation` 时将目标时长传递给进行页（URL query 或 sessionStorage，按 tech-stack 建议其一即可，但要“可回填”）。
- Landing 默认选中 10 分钟（P1）：若实现则写清楚；若不实现则明确不做。

**测试**
- Playwright：在 Landing 选择 5 分钟，点击开始，断言 URL 进入 `/meditation` 且目标时长被正确携带（query 或存储可读取的证据）。

---

## 4) Meditation 页（计时/阶段/动画/控制）

### Step 4.1 — 建立“主计时器”与暂停口径（不含暂停）
- 计时策略（按 tech-stack）：`requestAnimationFrame` 驱动，累积 active time。
- 暂停时：
  - elapsed 不增长
  - 阶段不推进
  - 动画冻结在当前比例

**测试**
- Playwright：开始后等待 2 秒，记录显示的 elapsed；点击暂停等待 2 秒，断言 elapsed 不变；点击继续等待 1 秒，断言 elapsed 增加约 1 秒（允许小误差，给一个容忍区间）。

### Step 4.2 — 阶段文案切换（含淡入淡出）
- 文案严格按 0–4/4–11/11–19 秒窗口切换。
- 过渡：0.5 秒淡入淡出（CSS transition）。

**测试**
- 人工验收 + 辅助自动化：
  - 人工：观察 1–2 轮，确认切换时机与过渡效果。
  - 自动：E2E 通过时间推进（或等待到阈值）断言页面在对应时间窗口出现对应文案（允许 0.3–0.5s 容差）。

### Step 4.3 — 呼吸圈缩放动画与阶段同步（80%→120%→80%）
- 规则：
  - 吸气 4s：从 0.8 放大到 1.2
  - 屏息 7s：保持 1.2
  - 呼气 8s：从 1.2 缩小到 0.8
- 缓动：`ease-in-out`
- 响应式：初始大小约视口高度 40%（实现方式可自由，但效果要接近）。

**测试**
- 人工验收：录屏/观察一轮，确认吸气变大、屏息保持、呼气变小，且 19 秒一轮。
- 可选自动：在固定时间点（例如 2s/6s/15s）读取元素 `transform`（scale）并断言大致范围（允许误差）。

### Step 4.4 — 粒子/光点渲染（先静态 P0，再考虑 P1 微动画）
- P0：渲染 **200** 个光点（170 主环 + 30 环周围散点），形成**离散光点堆叠的圆环形**（没有单独的实心圆/描边圆）。
  - 80%：分布在主环带上（沿圆周均匀/近似均匀采样，环带厚度可配置；当前目标：**thick ring**）
  - 20%：分布在主环周围（内外侧少量散点，作为“漂浮/外溢”效果）
  - 视觉：整体偏**subtle**（小点 + 轻微 glow），深色背景下不刺眼。
  - 环位置：主环在容器内留**comfortable margin**，避免 glow 被裁剪。
- P1（可选后续）：增加轻微漂移/闪烁，但不改变 80/20 结构。

**测试**
- RTL：断言光点元素数量为 200（通过 data-attribute 或可查询结构）。
- 人工验收：确认视觉上“主圈 + 少量外围散落”，背景深色不刺眼。

### Step 4.5 — 控制按钮（暂停/继续、重开、结束）
- 行为必须符合 GDD 表格：
  - 暂停：冻结计时与动画；按钮变“继续”
  - 继续：恢复
  - 重开：elapsed=0、轮数=0、回到吸气
  - 结束：立即进入完成页，标记“提前结束”
- 按钮弱化显示（P1）可后置；若做：默认 opacity 0.1，hover 到 1.0。

**测试**
- Playwright：
  1. 暂停/继续：断言文案切换、elapsed 冻结/恢复
  2. 重开：跑一会儿后点重开，断言 elapsed 接近 0，文案回到 “Breathe in”
  3. 结束：点击结束后进入 `/completion`，并显示“冥想结束”（提前结束标题）

### Step 4.6 — 自动结束条件：达到设定时长跳转完成页
- 条件：`elapsedActiveSec >= targetDurationSec` 触发自动结束
- 标记为“正常完成”

**测试**
- Playwright：将目标时长设为 1 分钟（或更短的测试时长通道），等待达到后自动跳转 `/completion`，断言标题为“冥想完成！”且存在轮数展示（正常完成才显示）。

---

## 5) Completion 页（统计展示与回流）

### Step 5.1 — 展示实际时长（统一口径）
- 格式：`X分YY秒` 或 `Xm Ys`，但要固定一种并在全站统一。
- 数据来源：从 Meditation 结束时写入（query/sessionStorage/状态传递），避免刷新丢失（至少“正常导航不丢”）。

**测试**
- RTL：给定一个模拟完成数据（例如 65 秒），断言显示为 `1分05秒`（或你选定的格式）并且补零规则一致。

### Step 5.2 — 正常完成显示轮数；提前结束不显示或显示“未完成”
- 正常完成：显示 `completedCycles = floor(elapsed/19)`
- 提前结束：不显示轮数或显示“未完成”（二选一，提前写死为一种）

**测试**
- RTL：分别以 endReason=normal/early 渲染页面：
  - normal：断言轮数元素存在且值正确
  - early：断言轮数元素存在且值为 floor(elapsedActiveSec/19)

### Step 5.3 — “再来一次”与“返回首页”
- 再来一次：回到 Landing 并保留上次时长选择
- 返回首页：回到 Landing 并清空选择（回到默认/未选状态，按 GDD）

**测试**
- Playwright：
  - 从正常完成页点“再来一次”，回到 `/` 后断言上次的时长仍被选中/输入框仍为上次值
  - 点“返回首页”，断言预设不选中且自定义为空（或回到默认规则）

---

## 6) 可访问性与兼容性底线（MVP 基线）

### Step 6.1 — 键盘可用（Tab 顺序与焦点可见）
- Landing：预设按钮、自定义输入、开始按钮均可 Tab 到达
- Meditation：控制按钮可 Tab 到达
- Completion：两个按钮可 Tab 到达

**测试**
- Playwright：使用键盘 `Tab` 导航，断言焦点依次落到关键控件且有可见焦点样式（可通过 CSS class 或可见性判断）。

### Step 6.2 — 不支持浏览器提示（仅策略，不需要做复杂 UA）
- MVP 可用最简策略：若检测到关键 API 缺失（如 `requestAnimationFrame` 极端情况），显示提示：“请使用最新版 Chrome / Firefox / Safari / Edge 浏览器访问”。

**测试**
- 单元测试：模拟缺失 API 的环境分支，断言提示文案出现（不必真的跑在旧浏览器）。

---

## 7) 性能与稳定性（只做“能被验收”的检查）

### Step 7.1 — 首屏加载与体积自检（目标导向）
- 记录一次构建产物体积与首屏加载（本地预览环境即可）。

**口径补充**
- <500KB：生产模式首次加载时 Network 中 /_next/static/ 的 JS(+CSS) Transferred 总和；优先 br（无 br 则 gzip），并注明。

**测试**
- 人工 + 指标记录：用浏览器 Performance / Network 截图记录首屏资源与加载时间，附在 `docs/perf-baseline.md`（作为“可验收证据”）。

### Step 7.2 — 动画帧率粗测（不做过度工程）
- 在典型桌面浏览器中观察卡顿；必要时减少光点数量或简化阴影。

**测试**
- 人工验收：打开 Performance monitor，观察 1 分钟内主观流畅、无明显掉帧；如要量化，记录 FPS 大致保持 >55 的截图/记录。

---

## 8) 最终验收：按 GDD 清单逐条过一遍

### Step 8.1 — 执行 GDD 第 10 节验收清单
- 按 10.1 / 10.2 / 10.3 三部分逐项验证。
- 输出一份 `MVP-acceptance-report.md`：
  - 每一条：通过/不通过
  - 不通过的：复现步骤 + 预期/实际

**测试**
- 这一步本身就是测试：验收清单全绿才允许发布。

---

## 附：建议的测试覆盖矩阵（便于快速分工）

| 模块 | 主要风险 | 最合适测试类型 | 最少用例数 |
|---|---|---|---|
| 时长输入校验 | 规则漏判、按钮可用性错误 | Unit + RTL | 6–10 |
| 计时/暂停口径 | 暂停仍计时、恢复跳秒 | Playwright | 3–5 |
| 阶段切换 | 边界点不准、文案错位 | Unit + E2E | 6 + 1 |
| 自动结束 | 不跳转/提前跳转 | Playwright | 1–2 |
| 完成页展示 | 正常/提前结束逻辑错误 | RTL | 2–4 |
| 回流按钮 | 不保留/不清空时长 | Playwright | 2 |

---

## 交付物清单（MVP 基础版应当最终具备）
- 3 个可访问路由页面（`/`、`/meditation`、`/completion`）
- 完整 4-7-8 引导闭环：选择时长 → 进行（可控）→ 完成统计 → 回流
- 明确一致的数据口径：elapsed 不含暂停；轮数按 19 秒计算
- 一套可运行的测试：Unit + 组件 + E2E 的最小组合，覆盖关键路径





